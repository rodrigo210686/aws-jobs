# Servidor AWS não resolve apara endereço especídfico dando erro NX can't resolver.


## Para resolver o problema foi preciso:


1 -  installar dnsmasq
```sh
yum install dnsmasq

systemctl start dnsmasq

systemctl enable dnsmasq

```

2 - No arquivo /etc/dnsmasq.conf inseri a linha abaixo para que o endereço que não resolvia pelo resolv.conf saisse pelo google
server=/preprod.brandsites.api.groupe-seb.com/8.8.8.8

3 - resolv.conf ficou configurado conforme abaixo


```sh
; generated by /usr/sbin/dhclient-script
search eu-west-1.compute.internal
nameserver 127.0.0.1
nameserver 10.160.9.2


```

## New Script Zabbix

```sh
#!/bin/bash
logFile="/tmp/InetumStartup.log"
check=0
yum install dnsmasq -y
systemctl start dnsmasq
systemctl enable dnsmasq

echo "
server=/preprod.brandsites.api.groupe-seb.com/8.8.8.8

" >> /etc/dnsmasq.conf

echo "
; generated by /usr/sbin/dhclient-script
search eu-west-1.compute.internal
nameserver 127.0.0.1
nameserver 10.160.9.2

" >> /etc/resolv.conf


check=1

while [ $check -ne 0 ]
do
    echo "$(date +%Y%m%d-%H%m%S) - Waiting communication to EFS. Testing again in 5 sec." >> $logFile
    sleep 5
    host fs-e369e2d7.efs.eu-west-1.amazonaws.com > /dev/null 2>&1
    check=$?
    /usr/bin/mkdir -p /var/lib/zabbix > /dev/null 2>&1
done


echo "
fs-e369e2d7     /etc/zabbix            efs     _netdev,tls,iam,accesspoint=fsap-006cf40b6293dad44 0 0
fs-e369e2d7     /etc/cron.d            efs     _netdev,tls,iam,accesspoint=fsap-096ebeae6216f2114 0 0
fs-e369e2d7     /home/zabbix           efs     _netdev,tls,iam,accesspoint=fsap-040d95cdc9ec4ca01 0 0
fs-e369e2d7     /usr/lib/zabbix        efs     _netdev,tls,iam,accesspoint=fsap-0633dd925e9a1bcf6 0 0
fs-e369e2d7     /etc/snmp              efs     _netdev,tls,iam,accesspoint=fsap-0bac817f00d12445f 0 0
fs-e369e2d7     /usr/share/snmp/mibs   efs     _netdev,tls,iam,accesspoint=fsap-0651a01135101b71f 0 0
" >> /etc/fstab
mount -a >> $logFile 2>&1
if [ $? -eq 0 ]
 then
    echo "$(date +%Y%m%d-%H%m%S) - Mount OK" >> $logFile
    if [ -z "$(ls -A /etc/zabbix)" ]
     then
        tar xvjf /opt/zabbix.tar.bz2 -C /etc/zabbix/ >> $logFile 2>&1
        if [ $? -ne 0 ]
         then
            echo "$(date +%Y%m%d-%H%m%S) - Erro on unzip file - zabbix.tar.bz2" >> $logFile
            exit 201
        fi
    fi
    #
    if [ -z "$(ls -A /home/zabbix)" ]
     then
        tar xvjf /opt/home.tar.bz2 -C /home/zabbix/ >> $logFile 2>&1
        if [ $? -ne 0 ]
         then
            echo "$(date +%Y%m%d-%H%m%S) - Erro on unzip file - home.tar.bz2" >> $logFile
            exit 202
        fi
    fi
    #
    if [ -z "$(ls -A /etc/snmp)" ]
     then
        tar xvjf /opt/snmp.tar.bz2 -C /etc/snmp/ >> $logFile 2>&1
        if [ $? -ne 0 ]
         then
            echo "$(date +%Y%m%d-%H%m%S) - Erro on unzip file - snmp.tar.bz2" >> $logFile
            exit 203
        fi
    fi
    #
    if [ -z "$(ls -A /usr/share/snmp/mibs)" ]
     then
        tar xvjf /opt/mibs.tar.bz2 -C /usr/share/snmp/mibs/ >> $logFile 2>&1
        if [ $? -ne 0 ]
         then
            echo "$(date +%Y%m%d-%H%m%S) - Erro on unzip file - mibs.tar.bz2" >> $logFile
            exit 204
        fi
    fi
    # Start the services
    systemctl enable postgresql-13 >> $logFile 2>&1
    systemctl start postgresql-13 >> $logFile 2>&1
    if [ $? -ne 0 ]
        then
        echo "$(date +%Y%m%d-%H%m%S) - Erro to start DB" >> $logFile
        exit 205
    fi

    systemctl enable zabbix-agent zabbix-proxy >> $logFile 2>&1
    systemctl start zabbix-agent zabbix-proxy >> $logFile 2>&1
    if [ $? -ne 0 ]
        then
        echo "$(date +%Y%m%d-%H%m%S) - Erro to Zabbix" >> $logFile
        exit 206
    fi

    echo "$(date +%Y%m%d-%H%m%S) - All done" >> $logFile

 else
    echo "$(date +%Y%m%d-%H%m%S) - Erro on mount step, check EFS configuration" >> $logFile
    exit 200
fi

```
